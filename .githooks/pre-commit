#!/usr/bin/env bash

set -eu

staged_rust_files=$(git diff --cached --name-only --diff-filter=ACMR -- '*.rs')

if [ -z "$staged_rust_files" ]; then
  exit 0
fi

if ! echo "$staged_rust_files" | xargs git diff --quiet --; then
  echo "pre-commit: staged Rust files have unstaged changes." >&2
  echo "Please stage or stash those changes, then commit again." >&2
  exit 1
fi

echo "pre-commit: running cargo fmt --all"
cargo fmt --all

echo "$staged_rust_files" | xargs git add --
